
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Manage Discount Codes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        :root{--primary-color:#7e69ab;--secondary-color:#9b87f5;--dark-color:#1a1f2c;--text-color:#e5deff;--success-color:#48bb78;--warning-color:#f6ad55;--danger-color:#f56565;--gray-color:#a0aec0;--glass-bg:rgba(26, 31, 44, 0.85);--glass-border:rgba(155, 135, 245, 0.4);--accent-gradient:linear-gradient(135deg, #667eea 0%, #764ba2 100%)}*{margin:0;padding:0;box-sizing:border-box;font-family:Tajawal,Poppins,sans-serif}body{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);background-attachment:fixed;color:var(--text-color);padding:20px;min-height:100vh}.container{max-width:1200px;margin:0 auto}.header{text-align:center;margin-bottom:40px}.header h1{font-size:36px;font-weight:700;background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}.back-btn{background:var(--primary-color);color:white;border:none;padding:12px 24px;border-radius:12px;cursor:pointer;margin-bottom:30px;text-decoration:none;display:inline-flex;align-items:center;gap:8px}.back-btn:hover{background:var(--secondary-color)}.discounts-section{background:var(--glass-bg);backdrop-filter:blur(20px);border:2px solid var(--glass-border);border-radius:25px;padding:30px;margin-bottom:30px}.btn{padding:12px 24px;border-radius:12px;border:none;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all 0.3s}.btn-success{background:var(--success-color);color:white}.btn-warning{background:var(--warning-color);color:white}.btn-danger{background:var(--danger-color);color:white}.btn:hover{transform:translateY(-2px)}.codes-table{width:100%;border-collapse:collapse;margin-top:20px}.codes-table th,.codes-table td{padding:15px;text-align:left;border-bottom:1px solid var(--glass-border)}.codes-table th{background:rgba(26,31,44,0.8);color:var(--text-color);font-weight:600}.codes-table td{color:var(--gray-color)}.status-active{color:var(--success-color);font-weight:600}.status-inactive{color:var(--danger-color);font-weight:600}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}.modal.active{display:flex}.modal-content{background:var(--glass-bg);backdrop-filter:blur(30px);border:2px solid var(--glass-border);border-radius:25px;padding:40px;max-width:500px;width:95%}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-color)}.form-group input{width:100%;padding:15px;border:2px solid var(--glass-border);border-radius:12px;background:rgba(26,31,44,0.8);color:var(--text-color);font-size:14px}.form-group input:focus{outline:none;border-color:var(--primary-color)}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/Store" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Store
            </a>
            <h1><i class="fas fa-percent"></i> Manage Discount Codes</h1>
        </div>

        <div class="discounts-section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3>Discount Codes</h3>
                <button class="btn btn-success" id="add-code-btn">
                    <i class="fas fa-plus"></i> Add Discount Code
                </button>
            </div>
            
            <table class="codes-table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Discount</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="codes-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Discount Code Modal -->
    <div id="code-modal" class="modal">
        <div class="modal-content">
            <h3>Add New Discount Code</h3>
            <form id="code-form">
                <div class="form-group">
                    <label for="code-name">Code</label>
                    <input type="text" id="code-name" required placeholder="e.g. SAVE20" style="text-transform:uppercase;">
                </div>
                <div class="form-group">
                    <label for="code-discount">Discount Percentage</label>
                    <input type="number" id="code-discount" min="1" max="100" required placeholder="e.g. 20">
                </div>
                <div style="display:flex;gap:15px;">
                    <button type="submit" class="btn btn-success">Create Code</button>
                    <button type="button" class="btn btn-danger" id="close-modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let discountCodes = [];

        function showToast(title, message, type = 'info') {
            alert(`${title}: ${message}`);
        }

        function loadDiscountCodes() {
            fetch('/api/store/discount-codes')
                .then(response => response.json())
                .then(data => {
                    discountCodes = data;
                    renderDiscountCodes();
                })
                .catch(console.error);
        }

        function renderDiscountCodes() {
            const tbody = document.getElementById('codes-table-body');
            tbody.innerHTML = '';
            
            discountCodes.forEach(code => {
                const row = document.createElement('tr');
                const createdDate = new Date(code.created_at * 1000).toLocaleDateString();
                
                row.innerHTML = `
                    <td><strong>${code.code}</strong></td>
                    <td>${(code.discount_percent * 100).toFixed(0)}%</td>
                    <td>
                        <span class="${code.active ? 'status-active' : 'status-inactive'}">
                            ${code.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${createdDate}</td>
                    <td>
                        <button class="btn btn-warning" onclick="toggleCode('${code.id}')" style="padding:8px 12px;margin-right:5px;">
                            <i class="fas fa-toggle-${code.active ? 'on' : 'off'}"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteCode('${code.id}')" style="padding:8px 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function toggleCode(id) {
            fetch(`/api/store/discount-codes/${id}/toggle`, {
                method: 'PUT'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Success', `Code ${data.active ? 'activated' : 'deactivated'}!`, 'success');
                    loadDiscountCodes();
                } else {
                    showToast('Error', 'Failed to toggle code status', 'error');
                }
            })
            .catch(() => showToast('Error', 'An error occurred', 'error'));
        }

        function deleteCode(id) {
            if (!confirm('Are you sure you want to delete this discount code?')) return;
            
            fetch(`/api/store/discount-codes/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Success', 'Discount code deleted!', 'success');
                    loadDiscountCodes();
                } else {
                    showToast('Error', 'Failed to delete code', 'error');
                }
            })
            .catch(() => showToast('Error', 'An error occurred', 'error'));
        }

        document.getElementById('add-code-btn').addEventListener('click', () => {
            document.getElementById('code-form').reset();
            document.getElementById('code-modal').classList.add('active');
        });

        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('code-modal').classList.remove('active');
        });

        document.getElementById('code-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const code = document.getElementById('code-name').value.toUpperCase();
            const discount = parseFloat(document.getElementById('code-discount').value) / 100;
            
            fetch('/api/store/discount-codes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({code, discount})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Success', 'Discount code created!', 'success');
                    document.getElementById('code-modal').classList.remove('active');
                    loadDiscountCodes();
                } else {
                    showToast('Error', data.error || 'Failed to create code', 'error');
                }
            })
            .catch(() => showToast('Error', 'An error occurred', 'error'));
        });

        loadDiscountCodes();
    </script>
</body>
</html>
