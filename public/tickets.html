
<!doctype html><html lang=en dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Tickets - Ticket System</title><meta name=description content="Ticket System"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><script src=https://cdn.socket.io/4.6.0/socket.io.min.js></script><style>:root{--primary-color:#7e69ab;--primary-hover:#6b5b9a;--secondary-color:#9b87f5;--secondary-hover:#8b77f0;--dark-color:#1a1f2c;--darker-color:#151a26;--light-color:#f1f0fb;--text-color:#e5deff;--text-muted:#b8b4d1;--success-color:#48bb78;--warning-color:#f6ad55;--danger-color:#f56565;--gray-color:#a0aec0;--glass-bg:rgba(26, 31, 44, 0.85);--glass-border:rgba(155, 135, 245, 0.3);--glass-hover:rgba(155, 135, 245, 0.1);--status-open:#48bb78;--status-closed:#f56565;--status-on-hold:#f6ad55;--shadow-sm:0 2px 4px rgba(0, 0, 0, 0.1);--shadow-md:0 4px 6px rgba(0, 0, 0, 0.1);--shadow-lg:0 10px 15px rgba(0, 0, 0, 0.2);--border-radius:12px;--border-radius-sm:8px;--border-radius-lg:16px;--transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);--transition-fast:all 0.2s cubic-bezier(0.4, 0, 0.2, 1)}*{margin:0;padding:0;box-sizing:border-box;font-family:Tajawal,Poppins,sans-serif}body{background:linear-gradient(135deg,var(--dark-color) 0,var(--darker-color) 100%);color:var(--text-color);min-height:100vh;overflow-x:hidden;background-size:cover;background-position:center;background-attachment:fixed}body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 50%,rgba(126,105,171,.1) 0,transparent 50%),radial-gradient(circle at 80% 20%,rgba(155,135,245,.1) 0,transparent 50%),radial-gradient(circle at 40% 80%,rgba(126,105,171,.05) 0,transparent 50%);pointer-events:none;z-index:-1}.container{display:flex;min-height:100vh;position:relative}.sidebar{width:280px;background:var(--glass-bg);backdrop-filter:blur(20px);border-right:1px solid var(--glass-border);padding:0;display:flex;flex-direction:column;transition:var(--transition);z-index:100;box-shadow:var(--shadow-lg)}.sidebar.collapsed{width:80px}.logo-container{padding:24px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--glass-border);background:linear-gradient(135deg,var(--glass-bg) 0,rgba(155,135,245,.1) 100%)}.logo{display:flex;align-items:center;transition:var(--transition)}.logo img{width:42px;height:42px;border-radius:50%;margin-right:12px;border:2px solid var(--primary-color);transition:var(--transition)}.logo img:hover{transform:scale(1.05);border-color:var(--secondary-color)}.logo-text{font-size:18px;font-weight:700;color:var(--text-color);white-space:nowrap;transition:var(--transition)}.menu-toggle{cursor:pointer;color:var(--text-color);background:0 0;border:none;font-size:20px;padding:8px;border-radius:var(--border-radius-sm);transition:var(--transition)}.menu-toggle:hover{background:var(--glass-hover);transform:scale(1.1)}.sidebar.collapsed .logo-text{opacity:0;transform:translateX(-20px)}.menu{list-style:none;padding:20px 0;margin:0;flex:1}.menu-item{padding:16px 24px;display:flex;align-items:center;cursor:pointer;color:var(--text-muted);transition:var(--transition);position:relative;margin:4px 12px;border-radius:var(--border-radius)}.menu-item::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:0;background:var(--primary-color);border-radius:2px;transition:var(--transition)}.menu-item.active,.menu-item:hover{background:linear-gradient(135deg,var(--primary-color) 0,var(--secondary-color) 100%);color:#fff;transform:translateX(4px);box-shadow:var(--shadow-md)}.menu-item.active::before,.menu-item:hover::before{height:24px}.menu-item i{width:24px;text-align:center;margin-right:16px;font-size:18px;transition:var(--transition)}.menu-item:hover i{transform:scale(1.1)}.menu-text{font-weight:500;transition:var(--transition)}.sidebar.collapsed .menu-text{opacity:0;transform:translateX(-20px)}.sidebar-bottom-toggle{display:none;padding:16px 24px;margin:4px 12px;cursor:pointer;color:var(--text-muted);background:transparent;border:none;border-radius:var(--border-radius);transition:var(--transition);justify-content:flex-start;align-items:center;font-size:18px;position:relative}.sidebar-bottom-toggle::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:0;background:var(--primary-color);border-radius:2px;transition:var(--transition)}.sidebar-bottom-toggle:hover{background:linear-gradient(135deg,var(--primary-color) 0,var(--secondary-color) 100%);color:#fff;transform:translateX(4px);box-shadow:var(--shadow-md)}.sidebar-bottom-toggle:hover::before{height:24px}.sidebar-bottom-toggle i{width:24px;text-align:center;margin-right:16px;font-size:18px;transition:var(--transition)}.sidebar-bottom-toggle:hover i{transform:scale(1.1)}.sidebar.collapsed .sidebar-bottom-toggle{display:flex}.sidebar.collapsed .menu-toggle{display:none}.notification-badge{position:absolute;top:6px;right:20px;background:linear-gradient(135deg,var(--danger-color),#ff8a80);color:#fff;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;box-shadow:0 2px 6px rgba(245,101,101,.4);animation:pulse 2s infinite}.main-content{flex:1;padding:32px;overflow-y:auto;position:relative}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;padding:24px 32px;background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-md)}.section-title{font-size:24px;margin-bottom:20px;color:var(--text-color);position:relative;font-weight:600}.card{background:var(--glass-bg);backdrop-filter:blur(15px);border:1px solid var(--glass-border);border-radius:12px;padding:20px;margin-bottom:20px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.1);transition:transform .3s ease,box-shadow .3s ease}.card:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,.15)}.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.card-title{font-size:18px;font-weight:700}.card-content{color:var(--text-color)}.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;margin-bottom:20px}.stat-card{background:var(--glass-bg);backdrop-filter:blur(10px);border:1px solid var(--glass-border);border-radius:12px;padding:18px;text-align:center;transition:all .3s ease}.stat-card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(126,105,171,.2)}.stat-value{font-size:24px;font-weight:700;margin-bottom:8px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.stat-label{font-size:13px;color:var(--gray-color)}.btn{padding:12px 24px;border-radius:var(--border-radius);border:none;font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;gap:8px;font-size:14px;box-shadow:var(--shadow-sm);position:relative;overflow:hidden}.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:var(--transition)}.btn:hover::before{left:100%}.btn-primary{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff}.btn-primary:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}.btn-secondary{background:var(--glass-bg);color:var(--text-color);border:1px solid var(--primary-color)}.btn-secondary:hover{background:var(--primary-color);transform:translateY(-2px);box-shadow:var(--shadow-md)}.btn-danger{background:linear-gradient(135deg,var(--danger-color),#fc8181);color:#fff}.btn-sm{padding:6px 12px;font-size:12px}.ticket-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background:var(--dark-color);border:1px solid var(--glass-border);border-radius:10px;margin-bottom:10px;cursor:pointer;transition:all .3s ease;position:relative}.ticket-item:hover{transform:translateY(-3px);background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));box-shadow:0 8px 25px rgba(126,105,171,.3)}.ticket-info{flex:1}.ticket-title{font-weight:600;margin-bottom:5px;display:flex;align-items:center;font-size:15px}.ticket-meta{font-size:12px;color:var(--gray-color);display:flex;gap:15px;margin-top:5px}.ticket-status{padding:6px 12px;border-radius:6px;font-size:11px;font-weight:600;color:#222}.ticket-type{padding:4px 8px;border-radius:12px;font-size:10px;font-weight:600;margin-left:8px}.ticket-type.public{background:linear-gradient(135deg,#4299e1,#63b3ed);color:#fff}.ticket-type.private{background:linear-gradient(135deg,#805ad5,#9f7aea);color:#fff}.status-open{background:linear-gradient(135deg,var(--status-open),#68d391);color:#fff}.status-closed{background:linear-gradient(135deg,var(--status-closed),#fc8181);color:#fff}.status-on-hold{background:linear-gradient(135deg,var(--status-on-hold),#f6e05e);color:#222}.ticket-detail{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(26,31,44,.9);backdrop-filter:blur(8px);z-index:1000;display:none;flex-direction:column}.ticket-header{display:flex;justify-content:space-between;padding:20px;background:var(--glass-bg);border-bottom:1px solid var(--glass-border);backdrop-filter:blur(15px)}.ticket-header-info{flex:1}.ticket-header-meta{display:flex;gap:20px;font-size:13px;color:var(--gray-color);margin-top:8px}.ticket-body{flex:1;display:flex;flex-direction:column;padding:20px;overflow:hidden}.ticket-description{background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:10px;padding:18px;margin-bottom:18px;backdrop-filter:blur(10px)}.message-container{flex:1;overflow-y:auto;padding:18px;background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:12px;max-height:55vh;backdrop-filter:blur(15px)}.message{display:flex;margin-bottom:18px;max-width:80%;position:relative}.message.outgoing{flex-direction:row-reverse;margin-left:auto}.message-avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;margin-right:10px;box-shadow:0 3px 10px rgba(0,0,0,.2)}.message.outgoing .message-avatar{margin-right:0;margin-left:10px}.message-avatar img{width:100%;height:100%;object-fit:cover}.message-content{background:var(--dark-color);border:1px solid var(--glass-border);border-radius:12px;padding:12px;max-width:100%;backdrop-filter:blur(10px);box-shadow:0 4px 15px rgba(0,0,0,.1)}.message.outgoing .message-content{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color))}.message-username{font-weight:600;font-size:13px;margin-bottom:6px;display:flex;align-items:center;gap:8px}.admin-badge{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-size:10px;padding:3px 8px;border-radius:12px;font-weight:600;box-shadow:0 4px 15px rgba(102,126,234,.3);text-transform:uppercase;letter-spacing:.5px;animation:adminGlow 3s ease-in-out infinite alternate}.message-text{word-break:break-word;font-size:14px;line-height:1.4}.message-time{text-align:right;font-size:10px;color:var(--gray-color);margin-top:6px}.message-attachments{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}.message-attachment{width:100px;height:100px;border-radius:6px;overflow:hidden;cursor:pointer;border:1px solid var(--glass-border);box-shadow:0 4px 12px rgba(0,0,0,.2)}.message-attachment img{width:100%;height:100%;object-fit:cover;transition:transform .3s ease}.message-attachment:hover img{transform:scale(1.05)}.message-input-container{display:flex;gap:12px;padding:18px 0}.message-input{flex:1;padding:12px 18px;border-radius:25px;border:1px solid var(--glass-border);background:var(--dark-color);color:var(--text-color);resize:none;outline:0;font-size:14px;backdrop-filter:blur(10px)}.message-input:focus{border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(126,105,171,.1)}input,select,textarea{padding:12px;border-radius:10px;border:1px solid var(--glass-border);background:var(--dark-color);color:var(--text-color);width:100%;outline:0;transition:all .3s ease;margin-bottom:15px;font-size:14px;backdrop-filter:blur(10px)}input:focus,select:focus,textarea:focus{border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(126,105,171,.1);transform:translateY(-2px)}textarea{resize:vertical}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1500;padding:20px;backdrop-filter:blur(5px)}.modal-content{background:var(--dark-color);border-radius:15px;width:100%;max-width:450px;border:1px solid var(--glass-border);box-shadow:0 20px 50px rgba(0,0,0,.3)}.modal-header{padding:20px;border-bottom:1px solid var(--glass-border);display:flex;justify-content:space-between;align-items:center}.modal-title{font-size:18px;font-weight:700}.modal-close{background:0 0;border:none;font-size:20px;cursor:pointer;color:var(--text-color);transition:transform .3s ease}.modal-close:hover{transform:scale(1.1)}.modal-body{padding:20px}.modal-footer{padding:20px;border-top:1px solid var(--glass-border);display:flex;justify-content:flex-end;gap:12px}.form-group{margin-bottom:18px}.form-group label{display:block;margin-bottom:8px;font-size:14px;font-weight:500}.rating-stars{display:flex;gap:8px;font-size:24px;margin-bottom:15px}.rating-stars i{color:var(--gray-color);cursor:pointer;transition:all .3s ease}.rating-stars i:hover{transform:scale(1.2)}.rating-stars i.active{color:gold;text-shadow:0 0 10px rgba(255,215,0,.5)}.text-gray-color{color:var(--gray-color)}.message-reactions{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid rgba(155,135,245,.2)}.reaction-item{background:rgba(155,135,245,.1);border:1px solid rgba(155,135,245,.3);border-radius:15px;padding:4px 8px;font-size:12px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:4px}.reaction-item:hover{background:rgba(155,135,245,.2);transform:scale(1.05)}.reaction-item.user-reacted{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border-color:var(--primary-color)}.emoji-picker{position:absolute;background:var(--dark-color);border:1px solid var(--glass-border);border-radius:12px;padding:15px;z-index:2000;display:none;box-shadow:0 10px 30px rgba(0,0,0,.3);backdrop-filter:blur(15px);min-width:280px}.emoji-picker.show{display:block;animation:slideUp .3s ease}.emoji-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}.emoji-btn{background:0 0;border:none;font-size:20px;cursor:pointer;padding:8px;border-radius:8px;transition:all .3s ease}.emoji-btn:hover{background:rgba(155,135,245,.2);transform:scale(1.2)}.message-actions{position:absolute;top:-8px;right:10px;display:none;background:var(--dark-color);border:1px solid var(--glass-border);border-radius:8px;padding:5px;box-shadow:0 5px 15px rgba(0,0,0,.2)}.message:hover .message-actions{display:flex}.action-btn{background:0 0;border:none;color:var(--text-color);cursor:pointer;padding:6px;border-radius:6px;font-size:12px;transition:all .3s ease}.action-btn:hover{background:rgba(155,135,245,.2);transform:scale(1.1)}.reply-indicator{background:rgba(155,135,245,.1);border-left:3px solid var(--primary-color);padding:8px;margin-bottom:8px;border-radius:0 8px 8px 0;font-size:12px;color:var(--gray-color)}.ticket-actions{display:flex;align-items:center;gap:15px;margin-top:8px}.reaction-summary{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--gray-color)}.reaction-summary .emoji{margin-right:3px}.reply-count{color:var(--primary-color);font-weight:500}.reply-count:hover{text-decoration:underline;cursor:pointer}#toast-container{position:fixed;top:24px;right:24px;z-index:2000}.toast{display:flex;align-items:center;background:var(--glass-bg);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:var(--border-radius-lg);padding:16px 24px;margin-bottom:12px;min-width:320px;max-width:480px;box-shadow:var(--shadow-lg);opacity:0;transform:translateX(100%);animation:slideInRight .4s ease-out forwards}.toast.removing{animation:slideOutRight .4s ease-out forwards}.toast-icon{font-size:20px;margin-right:16px;flex-shrink:0}.toast-content{flex:1}.toast-title{font-weight:600;font-size:15px;margin-bottom:4px}.toast-message{font-size:14px;color:var(--text-muted);line-height:1.4}.toast-close{background:0 0;border:none;color:var(--gray-color);font-size:18px;cursor:pointer;padding:4px;border-radius:4px;transition:var(--transition);margin-left:12px}.toast-close:hover{color:var(--text-color);background:var(--glass-hover)}#ticket-panel{position:fixed;bottom:20px;right:20px;background:var(--dark-color);border:1px solid var(--glass-border);border-radius:12px;overflow:hidden;min-width:280px;max-width:350px;max-height:280px;display:none;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,.3)}#ticket-panel-header{padding:12px 15px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));display:flex;justify-content:space-between;align-items:center;font-size:14px;font-weight:600}#ticket-panel-content{max-height:220px;overflow-y:auto}.ticket-status-panel{display:flex;align-items:center;padding:10px 15px;cursor:pointer;border-bottom:1px solid var(--glass-border);gap:12px;font-size:13px;transition:all .3s ease}.ticket-status-panel:hover{background:var(--glass-bg);transform:translateX(5px)}.ticket-indicator{width:10px;height:10px;border-radius:50%;background:var(--status-open)}.ticket-indicator.closed{background:var(--status-closed)}.ticket-indicator.on-hold{background:var(--status-on-hold)}.ticket-status-label{margin-right:auto;font-size:10px;padding:3px 8px;border-radius:6px}.char-counter{position:absolute;bottom:25px;right:20px;font-size:12px;color:var(--gray-color)}.new-badge{background:linear-gradient(135deg,var(--danger-color),#fc8181);color:#fff;font-size:11px;padding:2px 8px;border-radius:12px;margin-right:8px;font-weight:500;box-shadow:0 2px 8px rgba(245,101,101,.3)}.rated-badge{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#fff;font-size:11px;padding:2px 8px;border-radius:12px;margin-right:8px;font-weight:500;box-shadow:0 2px 8px rgba(245,158,11,.3)}.message-read-status{font-size:11px;margin-right:5px;color:var(--gray-color)}.message-read-status.read{color:#4299e1}.code-block{background:rgba(0,0,0,.3);padding:3px 6px;border-radius:6px;font-family:monospace;font-size:13px}.bold-text{font-weight:700}.italic-text{font-style:italic}.strikethrough-text{text-decoration:line-through}.closed-ticket{opacity:.7;pointer-events:none;position:relative}.ticket-viewers{display:flex;align-items:center;margin-top:10px}.viewer-avatars{display:flex;flex-wrap:nowrap;direction:ltr}.viewer-avatars img{width:24px;height:24px;border-radius:50%;border:2px solid var(--dark-color);margin-right:-8px;box-shadow:0 2px 6px rgba(0,0,0,.2)}.viewer-count{font-size:12px;color:var(--gray-color);margin-right:10px}.viewer-more{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;color:#fff;margin-right:-8px;border:2px solid var(--dark-color)}.attachment-badge{position:absolute;top:-5px;right:-5px;background:linear-gradient(135deg,var(--danger-color),#fc8181);color:#fff;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;box-shadow:0 2px 8px rgba(245,101,101,.4)}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}@keyframes adminGlow{0%{box-shadow:0 4px 15px rgba(102,126,234,.3)}100%{box-shadow:0 4px 20px rgba(102,126,234,.6)}}@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes slideInRight{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}@keyframes slideOutRight{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}@media (max-width:1024px){.main-content{padding:24px}.header{padding:20px 24px}}@media (max-width:768px){.container{flex-direction:column}.sidebar{width:100%;border-right:none;border-bottom:1px solid var(--glass-border);position:relative}.sidebar.collapsed{width:100%}.main-content{padding:16px}.header{flex-direction:column;gap:16px;padding:16px}.stats-grid{grid-template-columns:1fr}.ticket-header{flex-direction:column}.ticket-header-actions{margin-top:10px}.message-container{flex:1}.message{max-width:95%}.emoji-picker{min-width:250px;right:10px}}</style><script src=https://cdn.gpteng.co/gptengineer.js type=module></script><script src=lang-config.js></script><script src=system-config.js></script></head><body><div class=container><div class=sidebar><div class=logo-container><div class=logo><img src="" id=logo-img alt=Logo><div class=logo-text data-lang-key=sidebar.title>Ticket System</div></div><button class=menu-toggle id=toggle-sidebar><i class="fas fa-bars"></i></button></div><ul class=menu><li class=menu-item onclick='window.location.href="/Home"'><i class="fas fa-home"></i><span class=menu-text>Home</span></li><li class=menu-item onclick='window.location.href="/"'><i class="fas fa-chart-bar"></i><span class=menu-text data-lang-key=sidebar.dashboard>Dashboard</span></li><li class="menu-item active" onclick='window.location.href="/Tickets"'><i class="fas fa-ticket"></i><span class=menu-text data-lang-key=sidebar.tickets>Tickets</span><span class=notification-badge id=tickets-badge style=display:none>0</span></li><li class=menu-item onclick='window.location.href="/Users"'><i class="fas fa-users"></i><span class=menu-text data-lang-key=sidebar.users>Users</span><span class=notification-badge id=users-badge style=display:none>0</span></li><li class=menu-item onclick='window.location.href="/Ratings"'><i class="fas fa-star"></i><span class=menu-text data-lang-key=sidebar.ratings>Ratings</span><span class=notification-badge id=ratings-badge style=display:none>0</span></li><li class=menu-item onclick='window.location.href="/Store"'><i class="fas fa-store"></i><span class=menu-text data-lang-key=sidebar.store>Store</span></li><li class=menu-item onclick='window.location.href="/Settings"'><i class="fas fa-cog"></i><span class=menu-text data-lang-key=sidebar.settings>Settings</span></li><li class=menu-item id=logout-btn><i class="fas fa-sign-out-alt"></i><span class=menu-text data-lang-key=sidebar.logout>Logout</span></li></ul><button class="sidebar-bottom-toggle" id="bottom-toggle-sidebar"><i class="fas fa-bars"></i></button></div><div class=main-content><div class=header><div id=welcome-message></div><button class="btn btn-primary" id=login-btn><i class="fas fa-sign-in-alt"></i> <span data-lang-key=header.login>Login</span></button></div><div class=page-container id=tickets-page><h2 class=section-title data-lang-key=tickets.title>Tickets</h2><div class=stats-grid><div class=stat-card><div class=stat-value id=total-tickets>0</div><div class=stat-label data-lang-key=tickets.stats.totalTickets>Total Tickets</div></div><div class=stat-card><div class=stat-value id=open-tickets>0</div><div class=stat-label data-lang-key=tickets.stats.openTickets>Open Tickets</div></div><div class=stat-card><div class=stat-value id=closed-tickets>0</div><div class=stat-label data-lang-key=tickets.stats.closedTickets>Closed Tickets</div></div><div class=stat-card><div class=stat-value id=total-users>0</div><div class=stat-label data-lang-key=tickets.stats.totalUsers>Total Users</div></div></div><button class="btn btn-primary" id=tickets-new-btn><i class="fas fa-plus"></i> <span data-lang-key=tickets.newTicket>New Ticket</span></button><div class=card><div class=card-header><div class=card-title data-lang-key=tickets.recentTickets>Recent Tickets</div></div><div class=card-content id=recent-tickets><div class="text-center p-4 text-gray-color" data-lang-key=tickets.loading>Loading...</div></div></div><div class=card><div class=card-header><div class=card-title data-lang-key=tickets.allTickets>All Tickets</div></div><div class=card-content id=all-tickets><div class="text-center p-4 text-gray-color" data-lang-key=tickets.loading>Loading...</div></div></div></div></div></div><div id=ticket-detail class=ticket-detail><div class=ticket-header><div class=ticket-header-info><h2 id=ticket-detail-title>Ticket Title</h2><div class=ticket-header-meta><div id=ticket-detail-user><span data-lang-key=ticketDetail.user>User: </span>-</div><div id=ticket-detail-date><span data-lang-key=ticketDetail.date>Date: </span>-</div><div id=ticket-detail-status class=ticket-status>Open</div><div id=ticket-detail-type class=ticket-type>Public</div></div><div class=ticket-viewers id=ticket-detail-viewers><div class=viewer-count>0 <span data-lang-key=tickets.viewers>viewers</span></div><div class=viewer-avatars></div></div></div><div class=ticket-header-actions><button class="btn btn-secondary" id=ticket-back-btn><i class="fas fa-arrow-left"></i> <span data-lang-key=ticketDetail.back>Back</span></button><button class="btn btn-primary" id=ticket-accept-btn style=display:none><i class="fas fa-check"></i> <span data-lang-key=ticketDetail.acceptTicket>Accept Ticket</span></button><div class=admin-only-actions style=display:inline-block><button class="btn btn-primary" id=ticket-status-btn><i class="fas fa-sync-alt"></i> <span data-lang-key=ticketDetail.changeStatus>Change Status</span></button><button class="btn btn-secondary" id=ticket-freeze-btn><i class="fas fa-snowflake"></i> <span data-lang-key=ticketDetail.freezeTicket>Freeze Ticket</span></button><button class="btn btn-secondary" id=ticket-unfreeze-btn style=display:none><i class="fas fa-sun"></i> <span data-lang-key=ticketDetail.unfreezeTicket>Unfreeze Ticket</span></button><button class="btn btn-secondary" id=ticket-type-btn><i class="fas fa-exchange-alt"></i> <span data-lang-key=ticketDetail.changeType>Change Type</span></button><button class="btn btn-danger" id=ticket-ban-btn><i class="fas fa-ban"></i> <span data-lang-key=ticketDetail.banUser>Ban User</span></button></div><button class="btn btn-danger" id=ticket-close-btn><i class="fas fa-times"></i> <span data-lang-key=ticketDetail.closeTicket>Close Ticket</span></button></div></div><div class=ticket-body><div class=ticket-description id=ticket-detail-description>Ticket description...</div><div class=message-container id=message-container></div><div class=message-input-container><textarea class=message-input id=message-input data-lang-placeholder=ticketDetail.messageInput placeholder="Write a message..." rows=1></textarea><button class="btn btn-secondary" id=attachment-btn style=position:relative><i class="fas fa-paperclip"></i><span class=attachment-badge id=attachment-count style=display:none>0</span></button><button class="btn btn-primary" id=message-send-btn><i class="fas fa-paper-plane"></i></button><span id=char-count class=char-counter>0</span></div><input type=file id=attachment-input accept=image/* multiple style=display:none></div></div><div class=emoji-picker id=emoji-picker><div class=emoji-grid><button class=emoji-btn data-emoji=üëç>üëç</button><button class=emoji-btn data-emoji=üëé>üëé</button><button class=emoji-btn data-emoji=‚ù§Ô∏è>‚ù§Ô∏è</button><button class=emoji-btn data-emoji=üòÇ>üòÇ</button><button class=emoji-btn data-emoji=üòÆ>üòÆ</button><button class=emoji-btn data-emoji=üò¢>üò¢</button><button class=emoji-btn data-emoji=üò°>üò°</button><button class=emoji-btn data-emoji=üî•>üî•</button><button class=emoji-btn data-emoji=üíØ>üíØ</button><button class=emoji-btn data-emoji=‚ú®>‚ú®</button><button class=emoji-btn data-emoji=üéâ>üéâ</button><button class=emoji-btn data-emoji=üëè>üëè</button></div></div><div id=new-ticket-modal class=modal><div class=modal-content><div class=modal-header><h3 class=modal-title data-lang-key=modals.newTicket.title>New Ticket</h3><button class=modal-close id=ticket-modal-close>&times;</button></div><div class=modal-body><div class=form-group><label for=ticket-title data-lang-key=modals.newTicket.ticketTitle>Ticket Title</label><input id=ticket-title data-lang-placeholder=modals.newTicket.ticketTitlePlaceholder placeholder="Enter ticket title" maxlength=100 required></div><div class=form-group><label for=ticket-type data-lang-key=modals.newTicket.ticketType>Ticket Type</label><select id=ticket-type required><option value=public data-lang-key=tickets.typePublic>Public</option><option value=private data-lang-key=tickets.typePrivate>Private</option></select></div><div class=form-group><label for=ticket-description data-lang-key=modals.newTicket.ticketDescription>Ticket Description</label><textarea id=ticket-description rows=4 data-lang-placeholder=modals.newTicket.ticketDescriptionPlaceholder placeholder="Explain your issue or question" required></textarea></div><div class=form-group><label for=ticket-attachments data-lang-key=modals.newTicket.attachments>Attachments (optional, max 5 images)</label><input type=file id=ticket-attachments accept=image/* multiple><div id=attachments-preview class=message-attachments></div></div></div><div class=modal-footer><button class="btn btn-secondary" id=ticket-cancel-btn data-lang-key=modals.newTicket.cancel>Cancel</button><button class="btn btn-primary" id=ticket-submit-btn data-lang-key=modals.newTicket.create>Create Ticket</button></div></div></div><div id=status-modal class=modal><div class=modal-content><div class=modal-header><h3 class=modal-title data-lang-key=modals.status.title>Change Ticket Status</h3><button class=modal-close id=status-modal-close>&times;</button></div><div class=modal-body><div class=form-group><label for=ticket-status-select data-lang-key=modals.status.status>Status</label><select id=ticket-status-select><option value=open data-lang-key=tickets.status.open>Open</option><option value=closed data-lang-key=tickets.status.closed>Closed</option><option value=on-hold data-lang-key=tickets.status.onHold>On Hold</option></select></div></div><div class=modal-footer><button class="btn btn-secondary" id=status-cancel-btn data-lang-key=modals.status.cancel>Cancel</button><button class="btn btn-primary" id=status-submit-btn data-lang-key=modals.status.save>Save</button></div></div></div><div id=type-modal class=modal><div class=modal-content><div class=modal-header><h3 class=modal-title data-lang-key=modals.type.title>Change Ticket Type</h3><button class=modal-close id=type-modal-close>&times;</button></div><div class=modal-body><div class=form-group><label for=ticket-type-select data-lang-key=modals.type.type>Type</label><select id=ticket-type-select><option value=public data-lang-key=tickets.typePublic>Public</option><option value=private data-lang-key=tickets.typePrivate>Private</option></select></div></div><div class=modal-footer><button class="btn btn-secondary" id=type-cancel-btn data-lang-key=modals.type.cancel>Cancel</button><button class="btn btn-primary" id=type-submit-btn data-lang-key=modals.type.save>Save</button></div></div></div><div id=ban-modal class=modal><div class=modal-content><div class=modal-header><h3 class=modal-title data-lang-key=modals.ban.title>Ban User</h3><button class=modal-close id=ban-modal-close>&times;</button></div><div class=modal-body><div class=form-group><label for=ban-reason data-lang-key=modals.ban.reason>Ban Reason</label><textarea id=ban-reason rows=3 data-lang-placeholder=modals.ban.reasonPlaceholder placeholder="Enter ban reason"></textarea></div></div><div class=modal-footer><button class="btn btn-secondary" id=ban-cancel-btn data-lang-key=modals.ban.cancel>Cancel</button><button class="btn btn-danger" id=ban-submit-btn data-lang-key=modals.ban.ban>Ban User</button></div></div></div><div id=rate-modal class=modal><div class=modal-content><div class=modal-header><h3 class=modal-title data-lang-key=modals.rate.title>Rate Ticket</h3><button class=modal-close id=rate-modal-close>&times;</button></div><div class=modal-body><p data-lang-key=modals.rate.message>Please rate your experience with our support team</p><div class=rating-stars><i class="fas fa-star" data-rating=1></i><i class="fas fa-star" data-rating=2></i><i class="fas fa-star" data-rating=3></i><i class="fas fa-star" data-rating=4></i><i class="fas fa-star" data-rating=5></i></div><div class=form-group><label for=rating-comment data-lang-key=modals.rate.comment>Comment (optional)</label><textarea id=rating-comment rows=3 data-lang-placeholder=modals.rate.commentPlaceholder placeholder="Write your comment here"></textarea></div></div><div class=modal-footer><button class="btn btn-secondary" id=rate-cancel-btn data-lang-key=modals.rate.cancel>Cancel</button><button class="btn btn-primary" id=rate-submit-btn data-rating=0 data-lang-key=modals.rate.submit>Submit</button></div></div></div><div id=ticket-panel><div id=ticket-panel-header><div><i class="fas fa-ticket"></i> <span data-lang-key=panel.title>Open Tickets</span></div><button class="btn btn-sm" id=panel-close-btn><i class="fas fa-times"></i></button></div><div id=ticket-panel-content></div></div><div id=toast-container></div><audio id=background-music loop></audio><audio id=notification-sound src=https://files.catbox.moe/wzac7y></audio><audio id=rating-sound src=https://files.catbox.moe/ghzmdo.mp3></audio><audio id=message-sound src=https://files.catbox.moe/a6vhkl.mp3></audio><script src=index-auth.js></script><script>const sidebar=document.querySelector(".sidebar"),toggleSidebarBtn=document.getElementById("toggle-sidebar"),bottomToggleBtn=document.getElementById("bottom-toggle-sidebar"),loginBtn=document.getElementById("login-btn"),logoutBtn=document.getElementById("logout-btn"),newTicketBtn=document.getElementById("tickets-new-btn"),ticketsNewBtn=document.getElementById("tickets-new-btn"),newTicketModal=document.getElementById("new-ticket-modal"),ticketModalCloseBtn=document.getElementById("ticket-modal-close"),ticketSubmitBtn=document.getElementById("ticket-submit-btn"),ticketCancelBtn=document.getElementById("ticket-cancel-btn"),ticketBackBtn=document.getElementById("ticket-back-btn"),ticketAcceptBtn=document.getElementById("ticket-accept-btn"),ticketStatusBtn=document.getElementById("ticket-status-btn"),ticketTypeBtn=document.getElementById("ticket-type-btn"),ticketFreezeBtn=document.getElementById("ticket-freeze-btn"),ticketUnfreezeBtn=document.getElementById("ticket-unfreeze-btn"),ticketBanBtn=document.getElementById("ticket-ban-btn"),ticketCloseBtn=document.getElementById("ticket-close-btn"),messageInput=document.getElementById("message-input"),messageSendBtn=document.getElementById("message-send-btn"),attachmentBtn=document.getElementById("attachment-btn"),attachmentInput=document.getElementById("attachment-input"),attachmentCount=document.getElementById("attachment-count"),statusModal=document.getElementById("status-modal"),statusModalCloseBtn=document.getElementById("status-modal-close"),statusSubmitBtn=document.getElementById("status-submit-btn"),statusCancelBtn=document.getElementById("status-cancel-btn"),typeModal=document.getElementById("type-modal"),typeModalCloseBtn=document.getElementById("type-modal-close"),typeSubmitBtn=document.getElementById("type-submit-btn"),typeCancelBtn=document.getElementById("type-cancel-btn"),banModal=document.getElementById("ban-modal"),banModalCloseBtn=document.getElementById("ban-modal-close"),banSubmitBtn=document.getElementById("ban-submit-btn"),banCancelBtn=document.getElementById("ban-cancel-btn"),rateModal=document.getElementById("rate-modal"),rateModalCloseBtn=document.getElementById("rate-modal-close"),rateSubmitBtn=document.getElementById("rate-submit-btn"),rateCancelBtn=document.getElementById("rate-cancel-btn"),backgroundMusic=document.getElementById("background-music"),notificationSound=document.getElementById("notification-sound"),ratingSound=document.getElementById("rating-sound"),messageSound=document.getElementById("message-sound"),ticketDetail=document.getElementById("ticket-detail"),ticketPanel=document.getElementById("ticket-panel"),panelCloseBtn=document.getElementById("panel-close-btn"),adminOnlyActions=document.querySelector(".admin-only-actions"),emojiPicker=document.getElementById("emoji-picker"),socket=io();let currentUser=null,isAdmin=!1,currentTicket=null,settings={},lastMessageTimes={},selectedAttachments=[],seenRatings=JSON.parse(localStorage.getItem("seenRatings")||"[]"),seenUsers=JSON.parse(localStorage.getItem("seenUsers")||"[]"),seenTickets=JSON.parse(localStorage.getItem("seenTickets")||"[]"),ticketsToDelete={},lastAudioPlayed={notification:0,rating:0,message:0},currentRatingsPage=1,ratingsPerPage=10,currentUsersPage=1,usersPerPage=15,statusChangeEventSource=null,currentReactionTarget=null;function loadSidebarState(){const e=localStorage.getItem("sidebarCollapsed");return"true"===e}function saveSidebarState(e){localStorage.setItem("sidebarCollapsed",e.toString())}function toggleSidebar(){sidebar.classList.toggle("collapsed");const e=sidebar.classList.contains("collapsed");saveSidebarState(e)}function loadUserSettings(){try{const e=localStorage.getItem("userSettings");if(e)return settings=JSON.parse(e),void applySettings();fetch("/api/settings").then((e=>e.json())).then((e=>{settings=e,applySettings(),localStorage.setItem("userSettings",JSON.stringify(settings))})).catch((e=>{console.error("Error loading settings:",e)}))}catch(e){console.error("Error loading settings:",e)}}function checkSavedSession(e){fetch(`/auth/check-session?id=${e}`).then((e=>e.json())).then((e=>{e.authenticated?handleSuccessfulLogin(e.user,e.isAdmin):(localStorage.removeItem("ticketSystemUserId"),window.location.href="/auth/discord")})).catch((e=>{console.error("Error checking saved session:",e),localStorage.removeItem("ticketSystemUserId"),window.location.href="/auth/discord"}))}function checkAuthStatus(){fetch("/api/auth/status").then((e=>e.json())).then((e=>{e.authenticated?handleSuccessfulLogin(e.user,e.isAdmin):e.banned?(showToast(window.langConfig.getText("toast.banned"),window.langConfig.getText("toast.bannedMessage"),"error"),setTimeout((()=>{window.location.href="/auth/logout"}),3e3)):window.location.href="/auth/discord"})).catch((e=>{console.error("Error checking auth status:",e),window.location.href="/auth/discord"}))}function handleSuccessfulLogin(e,t){currentUser=e,isAdmin=t,localStorage.setItem("ticketSystemUserId",e.id),document.getElementById("welcome-message").textContent=`${window.langConfig.getText("header.welcome")}${e.global_name||e.username}`,loginBtn.style.display="none",isAdmin?(document.querySelectorAll(".admin-only").forEach((e=>{e.style.display="block"})),adminOnlyActions.style.display="inline-block"):(document.querySelectorAll(".admin-only").forEach((e=>{e.style.display="none"})),adminOnlyActions.style.display="none"),socket.emit("user_connected",{userId:currentUser.id}),loadStatistics(),loadRecentTickets(),loadAllTickets(),socket.emit("update_user_status",{userId:currentUser.id,status:"online"}),setInterval(checkAndDeleteClosedTickets,3e4)}function handleLoggedOut(){window.location.href="/auth/discord"}function applySettings(){settings.background&&(document.body.style.backgroundImage=`url('${settings.background}')`),settings.logo&&(document.getElementById("logo-img").src=settings.logo),settings.music&&(backgroundMusic.src=settings.music,document.addEventListener("click",(()=>{backgroundMusic.play().catch((()=>{}))}),{once:!0}))}function loadStatistics(){fetch("/api/statistics").then((e=>e.json())).then((e=>{document.getElementById("total-tickets").textContent=e.tickets.total,document.getElementById("open-tickets").textContent=e.tickets.open,document.getElementById("closed-tickets").textContent=e.tickets.closed,document.getElementById("total-users").textContent=e.users.total})).catch((e=>{console.error("Error loading statistics:",e)}))}function loadRecentTickets(){fetch("/api/tickets").then((e=>e.json())).then((e=>{const t=document.getElementById("recent-tickets");t.innerHTML="";const n=e.sort(((e,t)=>t.updatedAt-e.updatedAt)).slice(0,5);if(0===n.length)return void(t.innerHTML=`<div class="text-center p-4 text-gray-color">${window.langConfig.getText("tickets.noTickets")}</div>`);let s=0;n.forEach((e=>{const n=new Date(e.createdAt),a=`${n.getDate()}/${n.getMonth()+1}/${n.getFullYear()}`,i=!seenTickets.includes(e.id);if(i&&(s++,seenTickets.push(e.id)),!isAdmin&&"public"!==e.type&&e.userId!==currentUser.id)return;const c=document.createElement("div");c.className="ticket-item",i&&c.classList.add("new-ticket"),"closed"===e.status&&c.classList.add("closed-ticket"),c.setAttribute("data-ticket-id",e.id);let o="";if(e.viewers&&e.viewers.length>0){const t=e.viewers.slice(0,15),n=e.viewers.length-15;o=`<div class="ticket-viewers"><div class="viewer-count">${e.viewers.length} ${window.langConfig.getText("tickets.viewers")}</div><div class="viewer-avatars">${t.map((e=>`<img src="${e.avatar?`https://cdn.discordapp.com/avatars/${e.userId}/${e.avatar}.png`:"https://cdn.discordapp.com/embed/avatars/0.png"}" alt="${e.username}" title="${e.username}" />`)).join("")}${n>0?`<div class="viewer-more" title="${n} ${window.langConfig.getText("tickets.viewers")}">+${n}</div>`:""}</div></div>`}let r="",l="";if(e.messages&&e.messages.length>0){const t={};let n=0;e.messages.forEach((e=>{e.reactions&&Object.keys(e.reactions).forEach((e=>{t[e]=(t[e]||0)+1})),e.repliedTo&&n++})),Object.keys(t).length>0&&(r='<div class="reaction-summary">',Object.keys(t).slice(0,3).forEach((e=>{r+=`<span class="emoji">${e}</span>`})),Object.keys(t).length>3&&(r+=`<span>+${Object.keys(t).length-3}</span>`),r+="</div>"),n>0&&(l=`<span class="reply-count">${n} ${1===n?"reply":"replies"}</span>`)}c.innerHTML=`<div class="ticket-info"><div class="ticket-title">${e.frozen?'<i class="fas fa-snowflake" style="color:#00bcd4; margin-right:5px;"></i>':""}<span class="ticket-type ${e.type}">${"public"===e.type?'<i class="fas fa-users"></i>':'<i class="fas fa-lock"></i>'}</span>${e.title}${i?`<span class="new-badge">${window.langConfig.getText("tickets.new")}</span>`:""} ${e.rating?`<span class="rated-badge">${window.langConfig.getText("tickets.rated")}</span>`:""}</div><div class="ticket-meta"><span>${e.username}</span><span>${a}</span></div>${o}<div class="ticket-actions">${r}${l}</div></div><div class="ticket-status status-${e.status}">${translateStatus(e.status)}</div>`,t.appendChild(c),c.addEventListener("click",(function(){"closed"!==e.status?openTicket(this.getAttribute("data-ticket-id")):showToast(window.langConfig.getText("toast.warning"),window.langConfig.getText("tickets.closedTicketMessage"),"warning")}))})),localStorage.setItem("seenTickets",JSON.stringify(seenTickets));const a=document.getElementById("tickets-badge");s>0?(a.textContent=s,a.style.display="flex",playNotificationSound()):a.style.display="none"})).catch((e=>{console.error("Error loading recent tickets:",e)}))}function loadAllTickets(){fetch("/api/tickets").then((e=>e.json())).then((e=>{const t=document.getElementById("all-tickets");t.innerHTML="";const n=e.sort(((e,t)=>t.updatedAt-e.updatedAt));if(0!==n.length){const e=n.filter((e=>isAdmin||"public"===e.type||e.userId===currentUser.id));if(0===e.length)return void(t.innerHTML=`<div class="text-center p-4 text-gray-color">${window.langConfig.getText("tickets.noTickets")}</div>`);e.forEach((e=>{const n=new Date(e.createdAt),s=`${n.getDate()}/${n.getMonth()+1}/${n.getFullYear()}`,a=!seenTickets.includes(e.id),i=document.createElement("div");i.className="ticket-item","closed"===e.status&&i.classList.add("closed-ticket"),i.setAttribute("data-ticket-id",e.id);let c="";if(e.viewers&&e.viewers.length>0){const t=e.viewers.slice(0,15),n=e.viewers.length-15;c=`<div class="ticket-viewers"><div class="viewer-count">${e.viewers.length} ${window.langConfig.getText("tickets.viewers")}</div><div class="viewer-avatars">${t.map((e=>`<img src="${e.avatar?`https://cdn.discordapp.com/avatars/${e.userId}/${e.avatar}.png`:"https://cdn.discordapp.com/embed/avatars/0.png"}" alt="${e.username}" title="${e.username}" />`)).join("")}${n>0?`<div class="viewer-more" title="${n} ${window.langConfig.getText("tickets.viewers")}">+${n}</div>`:""}</div></div>`}let o="",r="";if(e.messages&&e.messages.length>0){const t={};let n=0;e.messages.forEach((e=>{e.reactions&&Object.keys(e.reactions).forEach((e=>{t[e]=(t[e]||0)+1})),e.repliedTo&&n++})),Object.keys(t).length>0&&(o='<div class="reaction-summary">',Object.keys(t).slice(0,3).forEach((e=>{o+=`<span class="emoji">${e}</span>`})),Object.keys(t).length>3&&(o+=`<span>+${Object.keys(t).length-3}</span>`),o+="</div>"),n>0&&(r=`<span class="reply-count">${n} ${1===n?"reply":"replies"}</span>`)}if(i.innerHTML=`<div class="ticket-info"><div class="ticket-title">${e.frozen?'<i class="fas fa-snowflake" style="color:#00bcd4; margin-right:5px;"></i>':""}<span class="ticket-type ${e.type}">${"public"===e.type?'<i class="fas fa-users"></i>':'<i class="fas fa-lock"></i>'}</span>${e.title}${a?`<span class="new-badge">${window.langConfig.getText("tickets.new")}</span>`:""} ${e.rating?`<span class="rated-badge">${window.langConfig.getText("tickets.rated")}</span>`:""}</div><div class="ticket-meta"><span>${e.username}</span><span>${s}</span></div>${c}<div class="ticket-actions">${o}${r}</div></div><div class="ticket-status status-${e.status}">${translateStatus(e.status)}</div>`,t.appendChild(i),i.addEventListener("click",(function(){"closed"!==e.status?openTicket(this.getAttribute("data-ticket-id")):showToast(window.langConfig.getText("toast.warning"),window.langConfig.getText("tickets.closedTicketMessage"),"warning")})),"closed"===e.status){const t=e.updatedAt+36e5;ticketsToDelete[e.id]=t}})),updateTicketPanel()}else t.innerHTML=`<div class="text-center p-4 text-gray-color">${window.langConfig.getText("tickets.noTickets")}</div>`})).catch((e=>{console.error("Error loading all tickets:",e)}))}function checkAndDeleteClosedTickets(){const e=Date.now(),t={...ticketsToDelete};Object.keys(t).forEach((n=>{const s=t[n];e>=s&&isAdmin&&fetch(`/api/tickets/${n}`,{method:"DELETE",headers:{"Content-Type":"application/json"}}).then((e=>{e.ok&&(delete ticketsToDelete[n],currentTicket&&currentTicket.id===n&&(closeTicketView(),showToast(window.langConfig.getText("toast.info"),window.langConfig.getText("toast.ticketDeleted"),"info")),loadRecentTickets(),loadAllTickets())})).catch((e=>console.error("Error deleting ticket:",e)))}))}function updateTicketPanel(){isAdmin&&fetch("/api/tickets").then((e=>e.json())).then((e=>{const t=e.filter((e=>"open"===e.status&&!e.accepted));if(0===t.length)return void(ticketPanel.style.display="none");const n=document.getElementById("ticket-panel-content");n.innerHTML="",t.forEach((e=>{n.innerHTML+=`<div class="ticket-status-panel" data-ticket-id="${e.id}"><div class="ticket-indicator ${e.status}"></div><div>${e.title}</div><span class="ticket-status-label status-${e.status}">${translateStatus(e.status)}</span></div>`})),document.querySelectorAll(".ticket-status-panel").forEach((e=>{e.addEventListener("click",(function(){openTicket(this.getAttribute("data-ticket-id")),ticketPanel.style.display="none"}))})),ticketPanel.style.display="block"})).catch((e=>{console.error("Error updating ticket panel:",e)}))}function openTicket(e){fetch(`/api/tickets/${e}`).then((e=>{if(!e.ok)throw new Error("Ticket not accessible");return e.json()})).then((t=>{if(currentTicket=t,!isAdmin&&"public"!==t.type&&t.userId!==currentUser.id)return void showToast(window.langConfig.getText("toast.error"),window.langConfig.getText("toast.error"),"error");document.getElementById("ticket-detail-title").textContent=t.title,document.getElementById("ticket-detail-user").textContent=`${window.langConfig.getText("ticketDetail.user")}${t.username}`;const n=new Date(t.createdAt);document.getElementById("ticket-detail-date").textContent=`${window.langConfig.getText("ticketDetail.date")}${n.getDate()}/${n.getMonth()+1}/${n.getFullYear()}`,document.getElementById("ticket-detail-description").textContent=t.description;const s=document.getElementById("ticket-detail-type");s.className="ticket-type "+t.type,s.textContent="public"===t.type?window.langConfig.getText("tickets.typePublic"):window.langConfig.getText("tickets.typePrivate"),updateTicketViewers(t.viewers),updateTicketStatusDisplay();const a=document.getElementById("message-container");if(a.innerHTML="",attachmentCount.style.display="none",attachmentCount.textContent="0",t.attachments&&t.attachments.length>0){const e=document.createElement("div");e.className="message-attachments",t.attachments.forEach((t=>{e.innerHTML+=`<div class="message-attachment"><img src="${t}" alt="ŸÖÿ±ŸÅŸÇ" onclick="window.open('${t}', '_blank')"></div>`})),a.appendChild(e)}t.messages.forEach((e=>{addMessageToDisplay(e)})),a.scrollTop=a.scrollHeight,socket.emit("join_ticket",e),isAdmin?(adminOnlyActions.style.display="inline-block",ticketFreezeBtn.style.display=t.frozen?"none":"inline-flex",ticketUnfreezeBtn.style.display=t.frozen?"inline-flex":"none",ticketAcceptBtn.style.display=t.accepted?"none":"inline-flex",ticketBanBtn.style.display=t.userId!==currentUser.id?"inline-flex":"none"):(adminOnlyActions.style.display="none",ticketCloseBtn.style.display=t.userId===currentUser.id&&"closed"!==t.status?"inline-flex":"none",ticketAcceptBtn.style.display="none",ticketBanBtn.style.display="none"),"closed"===t.status||t.frozen?disableMessageInput(t.frozen?window.langConfig.getText("ticketDetail.ticketFrozen"):window.langConfig.getText("ticketDetail.ticketClosed")):t.accepted||isAdmin?enableMessageInput():disableMessageInput(window.langConfig.getText("ticketDetail.waitingApproval")),t.messages&&t.messages.length>0&&t.messages.forEach((e=>{e.userId!==currentUser.id&&socket.emit("message_read",{ticketId:t.id,messageId:e.id,readBy:currentUser.id})})),ticketDetail.style.display="flex",seenTickets.includes(e)&&(document.querySelectorAll(`.ticket-item[data-ticket-id="${e}"] .new-badge`).forEach((e=>e.remove())),loadRecentTickets())})).catch((e=>{console.error("Error opening ticket:",e),showToast(window.langConfig.getText("toast.error"),"Error opening ticket","error")}))}function updateTicketViewers(e){const t=document.getElementById("ticket-detail-viewers");if(!e||0===e.length)return void(t.innerHTML=`<div class="viewer-count">0 ${window.langConfig.getText("tickets.viewers")}</div>`);const n=e.slice(0,15),s=e.length-15;let a=`<div class="viewer-count">${e.length} ${window.langConfig.getText("tickets.viewers")}</div><div class="viewer-avatars">${n.map((e=>`<img src="${e.avatar?`https://cdn.discordapp.com/avatars/${e.userId}/${e.avatar}.png`:"https://cdn.discordapp.com/embed/avatars/0.png"}" alt="${e.username}" title="${e.username}" />`)).join("")}${s>0?`<div class="viewer-more" title="${s} ${window.langConfig.getText("tickets.viewers")}">+${s}</div>`:""}</div>`;t.innerHTML=a}function updateTicketStatusDisplay(){const e=document.getElementById("ticket-detail-status");e.className="ticket-status",e.classList.add(`status-${currentTicket.status}`),e.textContent=translateStatus(currentTicket.status);let t=currentTicket.title;"closed"===currentTicket.status&&(t=`[${window.langConfig.getText("tickets.status.closed")}] ${t}`),currentTicket.frozen?document.getElementById("ticket-detail-title").innerHTML=`<i class="fas fa-snowflake" style="color:#00bcd4;"></i> ${t}`:document.getElementById("ticket-detail-title").textContent=t,"closed"===currentTicket.status||currentTicket.frozen?disableMessageInput(currentTicket.frozen?window.langConfig.getText("ticketDetail.ticketFrozen"):window.langConfig.getText("ticketDetail.ticketClosed")):currentTicket.accepted||isAdmin?enableMessageInput():disableMessageInput(window.langConfig.getText("ticketDetail.waitingApproval")),"closed"===currentTicket.status||isAdmin?ticketCloseBtn.style.display="none":ticketCloseBtn.style.display=currentTicket.userId===currentUser.id?"inline-flex":"none"}function enableMessageInput(){messageInput.disabled=!1,messageInput.placeholder=window.langConfig.getText("ticketDetail.messageInput"),messageSendBtn.disabled=!1,attachmentBtn.disabled=!1}function disableMessageInput(e){messageInput.disabled=!0,messageInput.placeholder=e,messageSendBtn.disabled=!0,attachmentBtn.disabled=!0}function sendMessage(){const e=messageInput.value.trim();if(!e&&!selectedAttachments.length)return;if(e&&e.length>500)return void showToast(window.langConfig.getText("toast.error"),window.langConfig.getText("messages.messageTooLong"),"error");const t=Date.now()-(lastMessageTimes[currentUser.id]||0);if(t<1e3)showToast(window.langConfig.getText("toast.waitMessage"),`${window.langConfig.getText("messages.rateLimit")} ${Math.ceil((1e3-t)/1e3)} ${window.langConfig.getText("messages.secondsBeforeNext")}`,"warning");else if(currentTicket){const t=[...selectedAttachments];selectedAttachments=[],attachmentCount.style.display="none",attachmentCount.textContent="0";let n=e;fetch(`/api/tickets/${currentTicket.id}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:n,attachments:t})}).then((e=>e.ok?e.json():e.json().then((e=>{throw e})))).then((e=>{messageInput.value="",document.getElementById("char-count").textContent="0",document.getElementById("attachments-preview").innerHTML="",lastMessageTimes[currentUser.id]=Date.now()})).catch((e=>{console.error("Error sending message:",e),showToast(window.langConfig.getText("toast.error"),e.message||"Error sending message","error")}))}}function formatMessageContent(e){return e?e.replace(/`([^`]+)`/g,'<span class="code-block">$1</span>').replace(/\*\*([^*]+)\*\*/g,'<span class="bold-text">$1</span>').replace(/\*([^*]+)\*/g,'<span class="italic-text">$1</span>').replace(/~~([^~]+)~~/g,'<span class="strikethrough-text">$1</span>'):""}function addMessageToDisplay(e){const t=document.getElementById("message-container"),n=e.userId===currentUser?.id,s=document.createElement("div");s.className="message "+(n?"outgoing":""),s.setAttribute("data-message-id",e.id);let a="";e.repliedTo&&(a=`<div class="reply-indicator"><i class="fas fa-reply"></i> Replying to: ${e.repliedTo.username} - ${e.repliedTo.content?e.repliedTo.content.substring(0,50)+"...":"Message"}</div>`);let i="";e.attachments&&e.attachments.length>0&&(i='<div class="message-attachments">',e.attachments.forEach((e=>{i+=`<div class="message-attachment"><img src="${e}" alt="ŸÖÿ±ŸÅŸÇ" onclick="window.open('${e}', '_blank')"></div>`})),i+="</div>");const c=new Date(e.createdAt),o=`${c.getHours()}:${c.getMinutes().toString().padStart(2,"0")}`;let r="";n&&e.readBy&&(r=e.readBy.length>0?'<span class="message-read-status read"><i class="fas fa-check-double"></i></span>':'<span class="message-read-status"><i class="fas fa-check"></i></span>');let l="";e.reactions&&Object.keys(e.reactions).length>0&&(l='<div class="message-reactions">',Object.keys(e.reactions).forEach((t=>{const n=e.reactions[t].length,s=e.reactions[t].includes(currentUser.id)?"user-reacted":"";l+=`<div class="reaction-item ${s}" data-emoji="${t}" data-message-id="${e.id}"><span>${t}</span><span>${n}</span></div>`})),l+="</div>"),s.innerHTML=`<div class="message-avatar"><img src="${e.avatar?`https://cdn.discordapp.com/avatars/${e.userId}/${e.avatar}.png`:"https://cdn.discordapp.com/embed/avatars/0.png"}" alt="${e.username}"></div><div class="message-content"><div class="message-username">${e.username} ${e.isAdmin?`<span class="admin-badge">${window.langConfig.getText("users.adminBadge")}</span>`:""}</div>${a}<div class="message-text">${formatMessageContent(e.content)}</div>${i}${l}<div class="message-time">${o}${r}</div></div><div class="message-actions"><button class="action-btn" onclick="showEmojiPicker('${e.id}')"><i class="fas fa-smile"></i></button><button class="action-btn" onclick="replyToMessage('${e.id}', '${e.username}', '${e.content?e.content.replace(/'/g,"\\'"):""}')" ><i class="fas fa-reply"></i></button></div>`,t.appendChild(s),t.scrollTop=t.scrollHeight,!n&&messageSound&&playMessageSound(),!n&&currentTicket&&socket.emit("message_read",{ticketId:currentTicket.id,messageId:e.id,readBy:currentUser.id}),s.querySelectorAll(".reaction-item").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.emoji;toggleReaction(e.dataset.messageId,t)}))}))}function showEmojiPicker(e){currentReactionTarget=e;const t=event.target.getBoundingClientRect();emojiPicker.style.position="fixed",emojiPicker.style.top=t.top-120+"px",emojiPicker.style.left=Math.min(t.left,window.innerWidth-300)+"px",emojiPicker.classList.add("show")}function replyToMessage(e,t,n){const s=document.querySelector(`[data-message-id="${e}"]`);if(s){const e=s.querySelector(".message-content"),a=document.createElement("div");a.className="reply-indicator",a.innerHTML=`<i class="fas fa-reply"></i> Replying to: ${t} - ${n?n.substring(0,50)+"...":"Message"}<button style="float: right; background: none; border: none; color: var(--gray-color);" onclick="this.parentElement.remove()">√ó</button>`;const i=document.querySelector(".message-input-container");i.insertBefore(a,i.firstChild),messageInput.focus(),messageInput.replyData={messageId:e,username:t,content:n}}}function toggleReaction(e,t){fetch(`/api/tickets/${currentTicket.id}/messages/${e}/reactions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({emoji:t,userId:currentUser.id})}).then((e=>e.json())).then((t=>{if(t.success){const n=document.querySelector(`[data-message-id="${e}"]`);if(n){const s=currentTicket.messages.find((t=>t.id===e));s&&(s.reactions=t.reactions,updateMessageReactions(n,s))}}})).catch((e=>{console.error("Error toggling reaction:",e),showToast("Error","Failed to update reaction","error")}))}function updateMessageReactions(e,t){let n=e.querySelector(".message-reactions");if(n&&n.remove(),t.reactions&&Object.keys(t.reactions).length>0){n=document.createElement("div"),n.className="message-reactions",Object.keys(t.reactions).forEach((e=>{const s=t.reactions[e].length,a=t.reactions[e].includes(currentUser.id)?"user-reacted":"";n.innerHTML+=`<div class="reaction-item ${a}" data-emoji="${e}" data-message-id="${t.id}"><span>${e}</span><span>${s}</span></div>`}));const s=e.querySelector(".message-time");s.parentNode.insertBefore(n,s),n.querySelectorAll(".reaction-item").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.emoji;toggleReaction(e.dataset.messageId,t)}))}))}}function updateTicketStatus(e){currentTicket&&("frozen"!==e||isAdmin?statusChangeEventSource!==e&&(statusChangeEventSource=e,fetch(`/api/tickets/${currentTicket.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:e})}).then((e=>e.json())).then((t=>{if(t.success&&(currentTicket.status="frozen"===e?currentTicket.status:e,currentTicket.frozen="frozen"===e,updateTicketStatusDisplay(),showToast(window.langConfig.getText("toast.success"),`${window.langConfig.getText("toast.statusChanged")}${translateStatus(e)}`,"success"),loadRecentTickets(),loadAllTickets(),loadStatistics(),"closed"===e&&currentTicket.userId===currentUser.id&&setTimeout((()=>{openRateModal(currentTicket.id)}),1e3),"closed"===e)){const e=Date.now()+36e5;ticketsToDelete[currentTicket.id]=e,isAdmin||(ticketCloseBtn.style.display="none")}})).catch((e=>{console.error("Error updating ticket status:",e),showToast(window.langConfig.getText("toast.error"),"Error updating ticket status","error")})).finally((()=>{setTimeout((()=>{statusChangeEventSource=null}),500)}))):showToast(window.langConfig.getText("toast.error"),"Only admins can freeze tickets","error"))}function updateTicketType(e){currentTicket&&isAdmin&&fetch(`/api/tickets/${currentTicket.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:e})}).then((e=>e.json())).then((t=>{if(t.success){currentTicket.type=e;const t=document.getElementById("ticket-detail-type");t.className="ticket-type "+e,t.textContent="public"===e?window.langConfig.getText("tickets.typePublic"):window.langConfig.getText("tickets.typePrivate"),showToast(window.langConfig.getText("toast.success"),window.langConfig.getText("toast.typeChanged")+("public"===e?window.langConfig.getText("tickets.typePublic"):window.langConfig.getText("tickets.typePrivate")),"success"),loadRecentTickets(),loadAllTickets()}})).catch((e=>{console.error("Error updating ticket type:",e),showToast(window.langConfig.getText("toast.error"),"Error updating ticket type","error")}))}function acceptTicket(){currentTicket&&fetch(`/api/tickets/${currentTicket.id}/accept`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}).then((e=>e.ok?e.json():e.json().then((e=>{throw e})))).then((e=>{e.success&&(currentTicket=e.ticket,showToast(window.langConfig.getText("toast.success"),window.langConfig.getText("toast.acceptedTicket"),"success"),ticketAcceptBtn.style.display="none",enableMessageInput(),updateTicketPanel())})).catch((e=>{console.error("Error accepting ticket:",e),showToast(window.langConfig.getText("toast.error"),"Error accepting ticket","error")}))}function banUser(e,t){fetch(`/api/users/${e}/ban`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reason:t})}).then((e=>e.ok?e.json():e.json().then((e=>{throw e})))).then((t=>{t.success&&(showToast(window.langConfig.getText("toast.success"),window.langConfig.getText("toast.userBanned"),"success"),banModal.style.display="none",currentTicket&&currentTicket.userId===e&&updateTicketStatus("closed"))})).catch((e=>{console.error("Error banning user:",e),showToast(window.langConfig.getText("toast.error"),"Error banning user","error")}))}function rateTicket(e,t,n){fetch(`/api/tickets/${e}/rate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rating:t,comment:n})}).then((e=>e.ok?e.json():e.json().then((e=>{throw e})))).then((e=>{e.success&&(showToast(window.langConfig.getText("toast.success"),window.langConfig.getText("toast.rateSuccess"),"success"),rateModal.style.display="none",playRatingSound(),setTimeout((()=>{closeTicketView()}),2e3))})).catch((e=>{console.error("Error rating ticket:",e),showToast(window.langConfig.getText("toast.error"),"Error submitting rating","error")}))}function openNewTicketModal(){fetch("/api/tickets").then((e=>e.json())).then((e=>{const t=e.filter((e=>e.userId===currentUser.id));if(t.length>0){const e=t.sort(((e,t)=>t.createdAt-e.createdAt))[0].createdAt+3e5;if(Date.now()<e){const t=e-Date.now();return void showToast(window.langConfig.getText("toast.waitMessage"),`${window.langConfig.getText("toast.waitMessage")} ${Math.ceil(t/6e4)} ${window.langConfig.getText("toast.beforeNextTicket")}`,"warning")}}document.getElementById("ticket-title").value="",document.getElementById("ticket-type").value="public",document.getElementById("ticket-description").value="",document.getElementById("ticket-attachments").value="",document.getElementById("attachments-preview").innerHTML="",newTicketModal.style.display="flex"})).catch((e=>{console.error("Error checking ticket cooldown:",e),showToast(window.langConfig.getText("toast.error"),"Error checking ticket creation cooldown","error")}))}function openBanModal(e){document.getElementById("ban-reason").value="",banSubmitBtn.setAttribute("data-user-id",e),banModal.style.display="flex"}function openRateModal(e){document.querySelectorAll(".rating-stars i").forEach((e=>{e.classList.remove("active")})),document.getElementById("rating-comment").value="",rateSubmitBtn.setAttribute("data-ticket-id",e),rateSubmitBtn.setAttribute("data-rating","0"),rateModal.style.display="flex"}function closeTicketView(){currentTicket&&(socket.emit("leave_ticket",currentTicket.id),currentTicket=null),ticketDetail.style.display="none"}function translateStatus(e){return"on-hold"===e?window.langConfig.getText("tickets.status.onHold"):window.langConfig.getText(`tickets.status.${e}`)}function showToast(e,t,n="info"){const s=document.getElementById("toast-container"),a=document.createElement("div");a.className="toast";let i="fa-info-circle";switch(n){case"success":i="fa-check-circle";break;case"error":i="fa-exclamation-circle";break;case"warning":i="fa-exclamation-triangle"}a.innerHTML=`<i class="fas ${i} toast-icon"></i><div class="toast-content"><div class="toast-title">${e}</div><div class="toast-message">${t}</div></div><button class="toast-close">&times;</button>`,s.appendChild(a),setTimeout((()=>{a.style.opacity="0",setTimeout((()=>{a.remove()}),300)}),5e3),a.querySelector(".toast-close").addEventListener("click",(()=>{a.style.opacity="0",setTimeout((()=>{a.remove()}),300)})),"error"!==n&&"warning"!==n||playNotificationSound()}function previewAttachment(e){return new Promise(((t,n)=>{if(!e.type.startsWith("image/"))return n("Only image files are allowed");if(e.size>5242880)return n("File size exceeds maximum 5MB");const s=new FileReader;s.onload=function(e){t(e.target.result)},s.onerror=function(){n("Error reading file")},s.readAsDataURL(e)}))}function playNotificationSound(){const e=Date.now();if(e-lastAudioPlayed.notification<5e3)return;lastAudioPlayed.notification=e;const t=document.getElementById("notification-sound");t&&(t.volume=.5,t.play().catch((e=>console.error("Error playing notification sound:",e))))}function playRatingSound(){const e=Date.now();if(e-lastAudioPlayed.rating<1e4)return;lastAudioPlayed.rating=e;const t=document.getElementById("rating-sound");t&&(t.volume=.7,t.play().catch((e=>console.error("Error playing rating sound:",e))))}function playMessageSound(){const e=Date.now();if(e-lastAudioPlayed.message<3e3)return;lastAudioPlayed.message=e;const t=document.getElementById("message-sound");t&&(t.volume=.4,t.play().catch((e=>console.error("Error playing message sound:",e))))}function checkAuthOnLoad(){const e=localStorage.getItem("ticketSystemUserId");e?checkSavedSession(e):window.location.href="/auth/discord",loadUserSettings()}loginBtn.addEventListener("click",(()=>{window.location.href="/auth/discord"})),logoutBtn.addEventListener("click",(()=>{localStorage.removeItem("ticketSystemUserId"),window.location.href="/auth/logout"})),toggleSidebarBtn.addEventListener("click",toggleSidebar),bottomToggleBtn.addEventListener("click",toggleSidebar),newTicketBtn?.addEventListener("click",openNewTicketModal),ticketsNewBtn?.addEventListener("click",openNewTicketModal),ticketModalCloseBtn.addEventListener("click",(()=>{newTicketModal.style.display="none"})),ticketCancelBtn.addEventListener("click",(()=>{newTicketModal.style.display="none"})),document.querySelectorAll(".emoji-btn").forEach((e=>{e.addEventListener("click",(()=>{if(currentReactionTarget){const t=e.dataset.emoji;toggleReaction(currentReactionTarget,t),emojiPicker.classList.remove("show"),currentReactionTarget=null}}))})),document.addEventListener("click",(e=>{emojiPicker.contains(e.target)||e.target.closest(".action-btn")||(emojiPicker.classList.remove("show"),currentReactionTarget=null)})),document.getElementById("ticket-attachments").addEventListener("change",(function(e){const t=e.target.files,n=document.getElementById("attachments-preview");if(t.length>5)return showToast(window.langConfig.getText("toast.error"),"You can select a maximum of 5 images","error"),void(this.value="");n.innerHTML="";for(let e=0;e<t.length;e++)previewAttachment(t[e]).then((e=>{n.innerHTML+=`<div class="message-attachment"><img src="${e}" alt="Attachment"></div>`})).catch((e=>{showToast(window.langConfig.getText("toast.error"),e,"error")}))})),ticketSubmitBtn.addEventListener("click",(function(){const e=document.getElementById("ticket-title").value,t=document.getElementById("ticket-type").value,n=document.getElementById("ticket-description").value;if(!e||!n)return void showToast(window.langConfig.getText("toast.error"),"Please fill in all required fields","error");const s=document.getElementById("ticket-attachments").files,a=[];if(s.length>0)for(let e=0;e<s.length;e++)a.push(previewAttachment(s[e]));Promise.all(a).then((s=>{fetch("/api/tickets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e,type:t,description:n,attachments:s})}).then((e=>e.ok?e.json():e.json().then((e=>{throw e})))).then((e=>{newTicketModal.style.display="none",showToast(window.langConfig.getText("toast.success"),window.langConfig.getText("toast.ticketCreated"),"success"),loadRecentTickets(),loadAllTickets(),loadStatistics(),openTicket(e.id)})).catch((e=>{console.error("Error creating ticket:",e),showToast(window.langConfig.getText("toast.error"),e.message||"Error creating ticket","error")}))})).catch((e=>{showToast(window.langConfig.getText("toast.error"),e,"error")}))})),messageInput.addEventListener("input",(function(){const e=this.value.length;document.getElementById("char-count").textContent=e})),messageSendBtn.addEventListener("click",sendMessage),messageInput.addEventListener("keypress",(e=>{if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const t=document.querySelector(".message-input-container .reply-indicator");if(t&&messageInput.replyData){const e=messageInput.value.trim();if(!e&&!selectedAttachments.length)return;const n={message:e,attachments:[...selectedAttachments],repliedTo:{messageId:messageInput.replyData.messageId,username:messageInput.replyData.username,content:messageInput.replyData.content}};fetch(`/api/tickets/${currentTicket.id}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then((e=>e.ok?e.json():e.json().then((e=>{throw e})))).then((e=>{messageInput.value="",document.getElementById("char-count").textContent="0",selectedAttachments=[],attachmentCount.style.display="none",attachmentCount.textContent="0",t.remove(),delete messageInput.replyData,lastMessageTimes[currentUser.id]=Date.now()})).catch((e=>{console.error("Error sending reply:",e),showToast(window.langConfig.getText("toast.error"),e.message||"Error sending reply","error")}))}else sendMessage()}})),attachmentBtn.addEventListener("click",(()=>{attachmentInput.click()})),attachmentInput.addEventListener("change",(function(e){const t=e.target.files;if(t.length>5)return showToast(window.langConfig.getText("toast.error"),"You can select a maximum of 5 images","error"),void(this.value="");selectedAttachments=[];for(let e=0;e<t.length;e++)previewAttachment(t[e]).then((e=>{selectedAttachments.push(e),attachmentCount.style.display="flex",attachmentCount.textContent=selectedAttachments.length})).catch((e=>{showToast(window.langConfig.getText("toast.error"),e,"error")}))})),ticketBackBtn.addEventListener("click",closeTicketView),ticketAcceptBtn.addEventListener("click",acceptTicket),ticketStatusBtn.addEventListener("click",(()=>{document.getElementById("ticket-status-select").value=currentTicket.status,statusModal.style.display="flex"})),ticketTypeBtn.addEventListener("click",(()=>{document.getElementById("ticket-type-select").value=currentTicket.type,typeModal.style.display="flex"})),ticketFreezeBtn.addEventListener("click",(()=>{updateTicketStatus("frozen")})),ticketUnfreezeBtn.addEventListener("click",(()=>{updateTicketStatus("open")})),ticketBanBtn.addEventListener("click",(()=>{currentTicket&&openBanModal(currentTicket.userId)})),ticketCloseBtn.addEventListener("click",(()=>{confirm("Are you sure you want to close this ticket?")&&updateTicketStatus("closed")})),statusModalCloseBtn.addEventListener("click",(()=>{statusModal.style.display="none"})),statusCancelBtn.addEventListener("click",(()=>{statusModal.style.display="none"})),statusSubmitBtn.addEventListener("click",(function(){updateTicketStatus(document.getElementById("ticket-status-select").value),statusModal.style.display="none"})),typeModalCloseBtn.addEventListener("click",(()=>{typeModal.style.display="none"})),typeCancelBtn.addEventListener("click",(()=>{typeModal.style.display="none"})),typeSubmitBtn.addEventListener("click",(function(){updateTicketType(document.getElementById("ticket-type-select").value),typeModal.style.display="none"})),banModalCloseBtn.addEventListener("click",(()=>{banModal.style.display="none"})),banCancelBtn.addEventListener("click",(()=>{banModal.style.display="none"})),banSubmitBtn.addEventListener("click",(function(){banUser(this.getAttribute("data-user-id"),document.getElementById("ban-reason").value)})),rateModalCloseBtn.addEventListener("click",(()=>{rateModal.style.display="none"})),rateCancelBtn.addEventListener("click",(()=>{rateModal.style.display="none"})),document.querySelectorAll(".rating-stars i").forEach((e=>{e.addEventListener("click",(function(){const e=parseInt(this.getAttribute("data-rating"));document.querySelectorAll(".rating-stars i").forEach((t=>{t.classList.toggle("active",parseInt(t.getAttribute("data-rating"))<=e)})),rateSubmitBtn.setAttribute("data-rating",e)}))})),rateSubmitBtn.addEventListener("click",(function(){const e=this.getAttribute("data-ticket-id"),t=parseInt(this.getAttribute("data-rating")||"0"),n=document.getElementById("rating-comment").value;0===t?showToast(window.langConfig.getText("toast.error"),"Please select a rating from 1 to 5 stars","error"):rateTicket(e,t,n)})),panelCloseBtn.addEventListener("click",(()=>{ticketPanel.style.display="none"})),socket.on("connect",(()=>{console.log("Connected to server via Socket.IO")})),socket.on("new_message",(e=>{currentTicket&&e&&addMessageToDisplay(e)})),socket.on("message_read",(e=>{if(currentTicket&&e.ticketId===currentTicket.id){const t=document.querySelector(`.message[data-message-id="${e.messageId}"]`);if(t){const e=t.querySelector(".message-time");if(e){const t=e.querySelector(".message-read-status");t?(t.classList.add("read"),t.innerHTML='<i class="fas fa-check-double"></i>'):e.innerHTML+='<span class="message-read-status read"><i class="fas fa-check-double"></i></span>'}}}})),socket.on("status_update",(e=>{currentTicket&&currentTicket.id===e.ticketId&&!statusChangeEventSource&&(currentTicket.status=e.status,currentTicket.frozen=e.frozen,updateTicketStatusDisplay()),loadRecentTickets(),loadAllTickets()})),socket.on("ticket_accepted",(e=>{currentTicket&&currentTicket.id===e.ticketId&&(currentTicket.accepted=!0,currentTicket.acceptedBy=e.acceptedBy,ticketAcceptBtn.style.display="none",enableMessageInput(),showToast(window.langConfig.getText("toast.success"),`${window.langConfig.getText("toast.acceptedTicket")} ${e.acceptedBy.username}`),updateTicketPanel())})),socket.on("reaction_update",(e=>{if(currentTicket&&currentTicket.id===e.ticketId){const t=document.querySelector(`[data-message-id="${e.messageId}"]`);if(t){const n=currentTicket.messages.find((t=>t.id===e.messageId));n&&(n.reactions=e.reactions,updateMessageReactions(t,n))}}})),socket.on("settings_update",(e=>{localStorage.getItem("userSettings")||applySettings()})),socket.on("ticket_deleted",(e=>{currentTicket&&currentTicket.id===e&&(closeTicketView(),showToast(window.langConfig.getText("toast.info"),window.langConfig.getText("toast.ticketDeleted"),"info")),delete ticketsToDelete[e],loadRecentTickets(),loadAllTickets()})),socket.on("new_ticket",(e=>{isAdmin&&(loadRecentTickets(),loadAllTickets(),loadStatistics(),updateTicketPanel(),showToast(window.langConfig.getText("toast.info"),`${window.langConfig.getText("tickets.newTicket")} ${e.username}: ${e.title}`,"info"),playNotificationSound())})),socket.on("user_connected",(e=>{console.log("User connected event received")})),socket.on("user_disconnected",(e=>{console.log("User disconnected event received")})),window.addEventListener("beforeunload",(()=>{currentUser&&socket.emit("update_user_status",{userId:currentUser.id,status:"offline"})})),document.addEventListener("DOMContentLoaded",(function(){if(loadSidebarState()&&sidebar.classList.add("collapsed"),window.langConfig){const e=localStorage.getItem("selectedLanguage");e&&window.langConfig.setLanguage(e),window.langConfig.updateUI()}window.systemConfig&&console.log("System config loaded"),checkAuthOnLoad()}))</script></body></html>
